<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Branching Workflow Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --muted:#6a6a6a; --line:#e5e5e5;
      --accent:#3b82f6; --accent-ghost:#e8f0ff; --danger:#e11d48; --radius:14px;
      --chip:#eef2ff; --chip-text:#1e3a8a; --chip-border:#c7d2fe;
    }
    html,body{margin:0;padding:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111}
    .wrap{padding:12px;max-width:1200px;margin:0 auto}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;margin-bottom:12px}
    .section h3{margin:0 0 8px 0;font-size:15px}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .rowline{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
    .rowline label{font-size:12px;color:#475569}
    input[type="text"], textarea, select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit
    }
    textarea{min-height:68px;resize:vertical}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.ghost{background:var(--accent-ghost);color:#274c9f;border-color:#cfe0ff}
    .btn.danger{background:#fff;color:var(--danger);border-color:#ffd1dc}
    .hint{font-size:12px;color:#6a6a6a;margin-top:2px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--chip);color:var(--chip-text);border:1px solid var(--chip-border);border-radius:999px;font-size:12px}
    .chip button{border:none;background:none;cursor:pointer;color:#6b7280}
    .add-assignee{display:flex;gap:8px;margin-top:8px}
    .add-assignee input{flex:1 1 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.02);position:relative}
    .card header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .card header input{flex:1 1 auto;border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:600;background:#fff}
    .iconbtn{border:none;background:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .iconbtn.red{width:34px;height:34px;border-radius:50%;background:var(--danger);color:#fff}
    .iconbtn.red svg{width:18px;height:18px}
    .meta{display:grid;grid-template-columns:1fr;gap:8px;margin:6px 0 10px}
    .meta .rowline{grid-template-columns:160px 1fr}
    .tag{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
    .row input[type="text"], .row select, .row input[list]{flex:1 1 40%;min-width:160px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .row .btn{padding:8px 10px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .footer{display:flex;gap:8px;justify-content:flex-end}
    .empty{border:1px dashed var(--line);border-radius:var(--radius);padding:16px;text-align:center;color:#6a6a6a;background:#fff}
    .mapline{font-size:12px;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px;margin-top:6px;white-space:pre-wrap}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:8px;border-radius:10px;font-size:13px;margin:8px 0;display:none}
    .ok{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;padding:8px;border-radius:10px;font-size:13px;margin:8px 0;display:none}
    label.small{font-size:12px;color:#475569}
    /* resources */
    details.resource{border:1px solid var(--line);border-radius:10px;padding:8px;margin:8px 0;background:#fff}
    details.resource summary{cursor:pointer;outline:none;font-weight:600}
    .resgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:8px}
    .resrow{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
    .resrow label{font-size:12px;color:#475569}
    .reshead{display:flex;align-items:center;gap:8px}
    .res-del{margin-left:auto}
    .mini{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Top-level workflow info -->
    <div class="section">
      <h3>Workflow Info</h3>
      <div class="grid2">
        <div class="rowline">
          <label>Workflow Title</label>
          <input id="wfTitle" type="text" placeholder="e.g., New Client Onboarding" />
        </div>
        <div class="rowline">
          <label>Workflow Starts When</label>
          <input id="wfStarts" type="text" placeholder="e.g., Contract signed" />
        </div>
        <div class="rowline">
          <label>Workflow Ends When</label>
          <input id="wfEnds" type="text" placeholder="e.g., Accounts funded + Welcome email sent" />
        </div>
        <div class="rowline" style="grid-column:1/-1">
          <label>Milestone(s)</label>
          <textarea id="wfMilestones" placeholder="One per line or comma-separated"></textarea>
        </div>
      </div>
    </div>

    <!-- Global assignee pool -->
    <div class="section">
      <h3>Possible Assignees</h3>
      <div class="hint">Add names once. Steps can then assign to a “Team Member” from this list, or mark as “Automated”.</div>
      <div class="chips" id="assigneeChips"></div>
      <div class="add-assignee">
        <input id="assigneeInput" type="text" placeholder="e.g., Arielle, Operations, Chad" />
        <button id="addAssigneeBtn" class="btn">Add</button>
      </div>
    </div>

    <!-- Top-level resources -->
    <div class="section">
      <h3>Resources</h3>
      <div class="hint">Attach forms, email templates, or other docs/links used across the workflow. For large files, prefer links.</div>
      <div id="topResources"></div>
      <div class="row" style="margin-top:8px">
        <select id="topResType">
          <option value="form">Form</option>
          <option value="email">Email Template</option>
          <option value="other">Other Document or Link</option>
        </select>
        <input id="topResName" type="text" placeholder="Resource name (required)" />
        <button id="addTopRes" class="btn">Add Resource</button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input id="stepNameInput" type="text" placeholder="New step name (e.g., Intro Call)" />
      <button id="addStepBtn" class="btn primary">Add Step</button>
      <button id="exportBtn" class="btn ghost" title="Download JSON">Download JSON</button>
      <button id="clearAllBtn" class="btn danger" title="Remove all steps">Clear All</button>
    </div>
    <div class="hint">Each step can branch by outcome. Choose: <b>Close Workflow</b>, <b>Restart Workflow</b>, <b>Restart Current Step</b>, or <b>Jump to Step</b> (then pick a step).</div>

    <div id="statusOk" class="ok">Saved.</div>
    <div id="statusErr" class="error"></div>

    <!-- Steps -->
    <div id="cards" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" style="display:none;">No steps yet. Add your first step above.</div>
  </div>

  <script>
    // Actions (branch outcomes)
    const ACTIONS = { CLOSE:'close', RESTART_WORKFLOW:'restart_workflow', RESTART_CURRENT:'restart_current', JUMP:'jump' };

    // State
    let steps = []; // [{ name, assigneeType:'team'|'automated', assignee:string, description, resources:[Resource], branches:[{ outcome, action, next|null }] }]
    let assigneePool = []; // [string,...]
    let title = "", startsWhen = "", endsWhen = "", milestones = [];
    let topResources = []; // [Resource]
    // Resource shape:
    // { type:'form'|'email'|'other', name, link, fileName, fileData, email?:{subject,body,to,from,conditions} }

    // DOM refs (top-level info)
    const wfTitle = document.getElementById('wfTitle');
    const wfStarts = document.getElementById('wfStarts');
    const wfEnds = document.getElementById('wfEnds');
    const wfMilestones = document.getElementById('wfMilestones');

    // Assignee pool
    const chips = document.getElementById('assigneeChips');
    const assigneeInput = document.getElementById('assigneeInput');
    const addAssigneeBtn = document.getElementById('addAssigneeBtn');

    // Top resources
    const topResList = document.getElementById('topResources');
    const topResType = document.getElementById('topResType');
    const topResName = document.getElementById('topResName');
    const addTopResBtn = document.getElementById('addTopRes');

    // Steps
    const stepNameInput = document.getElementById('stepNameInput');
    const addStepBtn = document.getElementById('addStepBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const cards = document.getElementById('cards');
    const emptyState = document.getElementById('emptyState');
    const statusOk = document.getElementById('statusOk');
    const statusErr = document.getElementById('statusErr');

    // Utils
    const debounce = (fn, ms=2000) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; };
    const showOk = () => { statusOk.style.display='block'; setTimeout(()=>statusOk.style.display='none', 900); };
    const showErr = (msg) => { statusErr.textContent = msg; statusErr.style.display='block'; setTimeout(()=>statusErr.style.display='none', 3000); };
    const allStepNames = () => steps.map(s=>s.name);
    const hasName = (n) => steps.some(s=>s.name.toLowerCase()===(n||'').toLowerCase());
    const uniqueName = (base) => { let n=(base||'').trim()||'Untitled Step'; if(!hasName(n))return n; let i=2; while(hasName(`${n} ${i}`)) i++; return `${n} ${i}`; };
    const sanitizeName = (s) => (s||"").trim().replace(/\s+/g,' ');

    const fileToDataUrl = (file) => new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(fr.result);
      fr.onerror=reject;
      fr.readAsDataURL(file);
    });

    // Step name propagation
    const renameStepGlobally = (oldName, newName) => {
      steps.forEach(s=>s.branches.forEach(b=>{
        if (b.action===ACTIONS.JUMP && b.next===oldName) b.next = newName;
      }));
    };
    const deleteStepGlobally = (name) => {
      steps = steps.filter(s=>s.name!==name);
      steps.forEach(s=>s.branches.forEach(b=>{
        if (b.action===ACTIONS.JUMP && b.next===name){ b.action=ACTIONS.CLOSE; b.next=null; }
      }));
    };
    const jumpTargets = (selfName) => allStepNames().filter(n => n.toLowerCase() !== (selfName||'').toLowerCase());

    // Persistence (debounced)
    const persist = debounce(() => {
      const payload = {
        title, startsWhen, endsWhen, milestones,
        assigneePool,
        resources: topResources,
        steps
      };
      try {
        JFCustomWidget.sendData({ value: JSON.stringify(payload) });
        showOk();
      } catch(e) {}
      render(); // keep UI synced
    }, 2000);

    const loadFromValue = (v) => {
      if (!v) return;
      try {
        const obj = JSON.parse(v);
        if (Array.isArray(obj)) { // legacy steps-only
          steps = obj;
        } else if (obj && typeof obj === 'object') {
          steps = Array.isArray(obj.steps) ? obj.steps : [];
          assigneePool = Array.isArray(obj.assigneePool) ? obj.assigneePool : [];
          title = obj.title || ""; startsWhen = obj.startsWhen || ""; endsWhen = obj.endsWhen || "";
          if (Array.isArray(obj.milestones)) milestones = obj.milestones;
          else if (obj.milestones) milestones = String(obj.milestones).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
          topResources = Array.isArray(obj.resources) ? obj.resources : [];
        }
      } catch(e){}
    };

    // Validation
    function validateAll() {
      const names = allStepNames();
      if (!names.length) return "Add at least one step.";
      for (const n of names) if (!n.trim()) return "Step names cannot be empty.";
      const lower = names.map(n=>n.toLowerCase());
      const dup = lower.find((n,i)=> lower.indexOf(n)!==i);
      if (dup) return "Step names must be unique.";
      for (const s of steps) {
        if (s.assigneeType === 'team' && s.assignee && !assigneePool.includes(s.assignee)) {
          return `Step "${s.name}" assigns to "${s.assignee}", which is not in Possible Assignees.`;
        }
        for (const b of s.branches) {
          if (!b.outcome || !b.outcome.trim()) return `Outcome label missing on step "${s.name}".`;
          if (![ACTIONS.CLOSE,ACTIONS.RESTART_WORKFLOW,ACTIONS.RESTART_CURRENT,ACTIONS.JUMP].includes(b.action))
            return `Invalid action on step "${s.name}".`;
          if (b.action===ACTIONS.JUMP) {
            if (!b.next || !b.next.trim()) return `On step "${s.name}", outcome "${b.outcome}" must specify a jump target.`;
          }
        }
      }
      return "";
    }

    // Top-level inputs
    wfTitle.addEventListener('input', ()=>{ title = wfTitle.value; persist(); });
    wfStarts.addEventListener('input', ()=>{ startsWhen = wfStarts.value; persist(); });
    wfEnds.addEventListener('input', ()=>{ endsWhen = wfEnds.value; persist(); });
    wfMilestones.addEventListener('input', ()=>{
      const raw = wfMilestones.value;
      milestones = raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      persist();
    });

    // Assignee pool UI
    function renderAssignees(){
      chips.innerHTML = "";
      assigneePool.forEach(name=>{
        const c = document.createElement('span'); c.className='chip';
        const txt = document.createElement('span'); txt.textContent = name;
        const x = document.createElement('button'); x.innerHTML = '&times;'; x.title='Remove';
        x.addEventListener('click', ()=>{
          assigneePool = assigneePool.filter(a=>a!==name);
          steps.forEach(s=>{
            if (s.assigneeType==='team' && s.assignee===name) s.assignee = "";
          });
          persist();
        });
        c.appendChild(txt); c.appendChild(x); chips.appendChild(c);
      });
    }
    addAssigneeBtn.addEventListener('click', ()=>{
      const n = sanitizeName(assigneeInput.value);
      if (!n) return;
      if (!assigneePool.includes(n)) assigneePool.push(n);
      assigneeInput.value = "";
      persist();
    });
    assigneeInput.addEventListener('keydown', (e)=>{
      if (e.key==='Enter'){ e.preventDefault(); addAssigneeBtn.click(); }
    });

    // Resource editors
    function resourceSummary(r){
      if (!r) return "(empty)";
      const base = r.name ? `${r.name}` : "(unnamed)";
      const type = r.type==='email' ? "Email Template"
                 : r.type==='form' ? "Form"
                 : "Other";
      return `${type}: ${base}`;
    }
    function resourceFields(container, r, onChange){
      // Build fields depending on type
      const grid = document.createElement('div'); grid.className = 'resgrid';

      // Common: name
      const rowName = document.createElement('div'); rowName.className='resrow';
      const lblName = document.createElement('label'); lblName.textContent='Name';
      const inpName = document.createElement('input'); inpName.type='text'; inpName.value=r.name||"";
      inpName.placeholder='Resource name';
      inpName.addEventListener('input', ()=>{ r.name = inpName.value; onChange(); });
      rowName.appendChild(lblName); rowName.appendChild(inpName);
      grid.appendChild(rowName);

      if (r.type==='email'){
        // Email fields
        const mk = (lab, key, ph='')=>{
          const row=document.createElement('div'); row.className='resrow';
          const l=document.createElement('label'); l.textContent=lab;
          const input=document.createElement(key==='body'?'textarea':'input');
          if (key!=='body') input.type='text';
          input.value=(r.email?.[key])||"";
          input.placeholder=ph;
          input.addEventListener('input', ()=>{
            r.email = r.email || {};
            r.email[key] = input.value;
            onChange();
          });
          row.appendChild(l); row.appendChild(input); grid.appendChild(row);
        };
        mk('Subject','subject','Subject line');
        mk('Body','body','Email body...');
        mk('To','to','email@example.com');
        mk('From','from','noreply@example.com');
        mk('Conditions','conditions','e.g., if client type = VIP');
      } else {
        // Link (URL)
        const rowLink = document.createElement('div'); rowLink.className='resrow';
        const lblLink = document.createElement('label'); lblLink.textContent='Link';
        const inpLink = document.createElement('input'); inpLink.type='text'; inpLink.placeholder='https://...';
        inpLink.value = r.link||"";
        inpLink.addEventListener('input', ()=>{ r.link = inpLink.value; onChange(); });
        rowLink.appendChild(lblLink); rowLink.appendChild(inpLink);
        grid.appendChild(rowLink);
      }

      // Optional file upload (any type, encoded to base64)
      const rowFile = document.createElement('div'); rowFile.className='resrow';
      const lblFile = document.createElement('label'); lblFile.textContent='Upload File';
      const inpFile = document.createElement('input'); inpFile.type='file';
      inpFile.addEventListener('change', async ()=>{
        const file = inpFile.files?.[0];
        if (!file) { r.fileName=""; r.fileData=""; onChange(); return; }
        r.fileName = file.name;
        try { r.fileData = await fileToDataUrl(file); } catch(e){ r.fileData=""; }
        onChange();
      });
      const mini = document.createElement('div'); mini.className='mini';
      mini.textContent = r.fileName ? `Attached: ${r.fileName}` : 'No file attached';
      rowFile.appendChild(lblFile); rowFile.appendChild(inpFile); grid.appendChild(rowFile);
      grid.appendChild(mini);

      container.appendChild(grid);
    }
    function renderResourceList(listEl, arr, onChange){
      listEl.innerHTML = "";
      if (!arr.length){
        const empty = document.createElement('div'); empty.className='mini'; empty.textContent='No resources yet.';
        listEl.appendChild(empty); return;
      }
      arr.forEach((r, idx)=>{
        const det = document.createElement('details'); det.className='resource';
        const sum = document.createElement('summary'); sum.className='reshead';
        const title = document.createElement('span'); title.textContent = resourceSummary(r);
        const del = document.createElement('button'); del.className='btn res-del'; del.textContent='Delete';
        del.addEventListener('click', (e)=>{ e.preventDefault(); arr.splice(idx,1); onChange(); });
        sum.appendChild(title); sum.appendChild(del);
        det.appendChild(sum);

        const inner = document.createElement('div');
        resourceFields(inner, r, onChange);
        det.appendChild(inner);

        listEl.appendChild(det);
      });
    }

    // Top resources UI
    function renderTopResources(){
      renderResourceList(topResList, topResources, persist);
    }
    addTopResBtn.addEventListener('click', ()=>{
      const t = topResType.value;
      const n = sanitizeName(topResName.value);
      if (!n){ showErr("Resource name is required."); return; }
      const base = { type:t, name:n, link:"", fileName:"", fileData:"" };
      if (t==='email') base.email = { subject:"", body:"", to:"", from:"", conditions:"" };
      topResources.push(base);
      topResName.value = "";
      persist();
    });

    // Render cards/steps
    function render(){
      // top-level reflect state
      wfTitle.value = title; wfStarts.value = startsWhen; wfEnds.value = endsWhen;
      wfMilestones.value = (milestones||[]).join('\n');
      renderAssignees();
      renderTopResources();

      if (!steps.length){ cards.innerHTML=""; emptyState.style.display=""; return; }
      emptyState.style.display="none"; cards.innerHTML="";

      steps.forEach((step, idx)=>{
        const card = document.createElement('div'); card.className='card';

        // header with name + red trash icon
        const header = document.createElement('header');
        const titleInput = document.createElement('input');
        titleInput.value = step.name; titleInput.placeholder="Step name";
        titleInput.addEventListener('change', ()=>{
          const next = uniqueName(titleInput.value);
          if (next !== step.name){ const old=step.name; step.name=next; renameStepGlobally(old,next); persist(); }
          else { step.name=next; persist(); }
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'iconbtn red'; delBtn.setAttribute('aria-label','Delete Step'); delBtn.title = 'Delete Step';
        delBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
            <path d="M10 11v6"></path>
            <path d="M14 11v6"></path>
            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
          </svg>`;
        delBtn.addEventListener('click', ()=>{
          if (confirm(`Delete "${step.name}"? Any branches pointing here will switch to Close Workflow.`)){
            deleteStepGlobally(step.name); persist();
          }
        });

        header.appendChild(titleInput);
        header.appendChild(delBtn);

        // meta: assignee type/name + description
        const meta = document.createElement('div'); meta.className='meta';

        // Assignee Type
        const atRow = document.createElement('div'); atRow.className='rowline';
        const atLbl = document.createElement('label'); atLbl.textContent='Assignee Type'; atLbl.className='small';
        const atSel = document.createElement('select');
        [
          {v:'team', label:'Team Member'},
          {v:'automated', label:'Automated'}
        ].forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.label; atSel.appendChild(opt); });
        if (!step.assigneeType) step.assigneeType = 'team';
        atSel.value = step.assigneeType;
        atSel.addEventListener('change', ()=>{
          step.assigneeType = atSel.value;
          if (step.assigneeType!=='team') step.assignee = "";
          persist(); render();
        });
        atRow.appendChild(atLbl); atRow.appendChild(atSel);

        // Assignee Name (only if team)
        const anRow = document.createElement('div'); anRow.className='rowline';
        const anLbl = document.createElement('label'); anLbl.textContent='Assignee'; anLbl.className='small';
        if (step.assigneeType==='team'){
          const nameSel = document.createElement('select');
          nameSel.innerHTML = `<option value="">Select a team member…</option>`;
          assigneePool.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; nameSel.appendChild(o); });
          if (!assigneePool.includes(step.assignee)) step.assignee = "";
          nameSel.value = step.assignee || "";
          nameSel.addEventListener('change', ()=>{ step.assignee = nameSel.value || ""; persist(); });
          anRow.appendChild(anLbl); anRow.appendChild(nameSel);
        } else {
          const info = document.createElement('div'); info.style.color="#475569"; info.textContent="Automated";
          anRow.appendChild(anLbl); anRow.appendChild(info);
        }

        // Description
        const descLbl = document.createElement('label'); descLbl.textContent='Description'; descLbl.className='small';
        const descTa = document.createElement('textarea'); descTa.placeholder='Notes, details, instructions…';
        descTa.value = step.description || "";
        descTa.addEventListener('input', ()=>{ step.description = descTa.value; persist(); });

        // Step resources (collapsible list)
        const resHdr = document.createElement('div'); resHdr.className='tag'; resHdr.textContent='Resources';
        const stepResList = document.createElement('div');
        if (!Array.isArray(step.resources)) step.resources = [];
        const addStepResWrap = document.createElement('div'); addStepResWrap.className='row';
        const stepResType = document.createElement('select');
        ['form','email','other'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=(t==='email'?'Email Template':t==='form'?'Form':'Other Document or Link'); stepResType.appendChild(o); });
        const stepResName = document.createElement('input'); stepResName.type='text'; stepResName.placeholder='Resource name (required)';
        const addStepResBtn = document.createElement('button'); addStepResBtn.className='btn'; addStepResBtn.textContent='Add Resource';
        addStepResBtn.addEventListener('click', ()=>{
          const t = stepResType.value;
          const n = sanitizeName(stepResName.value);
          if (!n){ showErr("Resource name is required."); return; }
          const base = { type:t, name:n, link:"", fileName:"", fileData:"" };
          if (t==='email') base.email = { subject:"", body:"", to:"", from:"", conditions:"" };
          step.resources.push(base);
          stepResName.value = "";
          persist();
        });
        addStepResWrap.appendChild(stepResType);
        addStepResWrap.appendChild(stepResName);
        addStepResWrap.appendChild(addStepResBtn);

        // outcomes
        const rowsWrap = document.createElement('div');

        step.branches.forEach((branch, bIdx)=>{
          const row = document.createElement('div'); row.className='row';

          const outcomeInput = document.createElement('input');
          outcomeInput.type='text'; outcomeInput.placeholder='Outcome (e.g., Yes / No / Needs Review)';
          outcomeInput.value = branch.outcome || "";
          outcomeInput.addEventListener('input', ()=>{ branch.outcome = outcomeInput.value; persist(); });

          const thenLbl = document.createElement('label'); thenLbl.className='small'; thenLbl.textContent='Then:';

          // action select
          const actionSelect = document.createElement('select');
          [
            {v:'close', label:'Close Workflow'},
            {v:'restart_workflow', label:'Restart Workflow'},
            {v:'restart_current', label:'Restart Current Step'},
            {v:'jump', label:'Jump to Step'}
          ].forEach(opt=>{
            const o=document.createElement('option'); o.value=opt.v; o.textContent=opt.label; actionSelect.appendChild(o);
          });
          if (!branch.action) branch.action = 'close';
          actionSelect.value = branch.action;

          const jumpWrap = document.createElement('div'); jumpWrap.style.display='contents';

          const makeJumpControl = ()=>{
            jumpWrap.innerHTML = "";
            if (branch.action !== 'jump') return;

            const lbl = document.createElement('label'); lbl.className='small'; lbl.textContent='Step:';
            const input = document.createElement('input'); input.setAttribute('list', `dl-${idx}-${bIdx}`);
            input.placeholder='Type or select a step'; input.value = branch.next || "";
            const dl = document.createElement('datalist'); dl.id=`dl-${idx}-${bIdx}`;
            jumpTargets(step.name).forEach(n=>{ const opt=document.createElement('option'); opt.value=n; dl.appendChild(opt); });
            input.addEventListener('input', ()=>{ branch.next = (input.value||"").trim() || null; persist(); });

            const mini = document.createElement('div'); mini.className='row';
            mini.appendChild(lbl); mini.appendChild(input); mini.appendChild(dl);
            jumpWrap.appendChild(mini);
          };
          const syncJumpControl = ()=> makeJumpControl();

          actionSelect.addEventListener('change', ()=>{
            branch.action = actionSelect.value;
            if (branch.action !== 'jump') branch.next = null;
            persist(); syncJumpControl();
          });

          const delOutcomeBtn = document.createElement('button'); delOutcomeBtn.className='btn'; delOutcomeBtn.textContent='Delete';
          delOutcomeBtn.addEventListener('click', ()=>{ step.branches.splice(bIdx,1); persist(); });

          row.appendChild(outcomeInput);
          row.appendChild(thenLbl);
          row.appendChild(actionSelect);
          row.appendChild(delOutcomeBtn);
          rowsWrap.appendChild(row);
          rowsWrap.appendChild(jumpWrap);
          syncJumpControl();
        });

        const addOutcomeRow = document.createElement('div'); addOutcomeRow.className='footer';
        const addOutcomeBtn = document.createElement('button'); addOutcomeBtn.className='btn'; addOutcomeBtn.textContent='Add Outcome';
        addOutcomeBtn.addEventListener('click', ()=>{ step.branches.push({ outcome:"", action:'close', next:null }); persist(); });
        addOutcomeRow.appendChild(addOutcomeBtn);

        const map = document.createElement('div'); map.className='mapline'; map.textContent = prettyMap(step);

        // assemble card
        card.appendChild(header);

        const metaWrap = document.createElement('div'); metaWrap.className='meta';
        // Assignee rows
        metaWrap.appendChild(atRow);
        metaWrap.appendChild(anRow);
        // Description
        metaWrap.appendChild(descLbl);
        metaWrap.appendChild(descTa);
        // Step resources
        metaWrap.appendChild(resHdr);
        const stepResContainer = document.createElement('div');
        renderResourceList(stepResContainer, step.resources, persist);
        metaWrap.appendChild(stepResContainer);
        metaWrap.appendChild(addStepResWrap);

        card.appendChild(metaWrap);

        const tag = document.createElement('div'); tag.className='tag'; tag.textContent=`Step ${idx+1}`;
        card.appendChild(tag);
        card.appendChild(document.createElement('div')).className='divider';
        card.appendChild(rowsWrap);
        card.appendChild(addOutcomeRow);
        card.appendChild(map);
        cards.appendChild(card);
      });
    }

    function prettyMap(step){
      if (!step.branches.length) return "No outcomes defined yet.";
      const who = step.assigneeType==='team' ? (step.assignee||'(unassigned)') : 'Automated';
      const head = `Assigned to: ${who}`;
      const lines = step.branches.map(b=>{
        const out = (b.outcome||'').trim() || "(no label)";
        if (b.action === 'close') return `• ${out} → Close Workflow`;
        if (b.action === 'restart_workflow') return `• ${out} → Restart Workflow`;
        if (b.action === 'restart_current') return `• ${out} → Restart Current Step`;
        if (b.action === 'jump') return `• ${out} → Jump to Step ${b.next || "(unset)"}`;
        return `• ${out} → (invalid action)`;
      });
      return [head, ...lines].join('\n');
    }

    // Toolbar actions
    addStepBtn.addEventListener('click', ()=>{
      const base = stepNameInput.value.trim() || "New Step";
      const name = uniqueName(base);
      steps.push({ name, assigneeType:'team', assignee:"", description:"", resources:[], branches: [] });
      stepNameInput.value = "";
      persist();
    });

    exportBtn.addEventListener('click', ()=>{
      const payload = JSON.stringify({
        title, startsWhen, endsWhen, milestones,
        assigneePool,
        resources: topResources,
        steps
      }, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'workflow.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    clearAllBtn.addEventListener('click', ()=>{
      if (confirm("Clear all steps and resources? This cannot be undone.")){
        steps = []; title=""; startsWhen=""; endsWhen=""; milestones=[]; assigneePool=[]; topResources=[];
        persist();
      }
    });

    // Jotform integration
    JFCustomWidget.subscribe("ready", function(formData){
      if (formData && typeof formData.value === 'string') loadFromValue(formData.value);
      render(); persist();
    });

    JFCustomWidget.subscribe("submit", function(){
      const err = validateAll();
      const value = JSON.stringify({
        title, startsWhen, endsWhen, milestones,
        assigneePool, resources: topResources, steps
      });
      if (err) {
        showErr(err);
        JFCustomWidget.sendSubmit({ valid:false, value });
        return;
      }
      JFCustomWidget.sendSubmit({ valid:true, value });
    });
  </script>
</body>
</html>
